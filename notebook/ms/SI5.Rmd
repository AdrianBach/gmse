---
title: 'GMSE: an R package for generalised management strategy evaluation'
author: A. Bradley Duthie&#xb9;&#xb3;, Jeremy J. Cusack&#xb9;, Isabel L. Jones&#xb9;,
  Erlend B. Nilsen&#xb2;, Roc&#0237;o A. Pozo&#xb9;, O. Sarobidy Rakotonarivo&#xb9;,
  Bram Van Moorter&#xb2;, and Nils Bunnefeld&#xb9;
date: '[1] Biological and Environmental Sciences, University of Stirling, Stirling,
  UK [2] Norwegian Institute for Nature Research, Trondheim, Norway [3] alexander.duthie@stir.ac.uk'
output:
  pdf_document:
    citation_package: natbib
    fig_caption: yes
  html_document: default
  word_document:
    fig_caption: yes
    reference_docx: docx_template.docx
header-includes: null
linestretch: 1
link-citations: yes
linkcolor: blue
bibliography: gmse.bib
subtitle: Supporting Information 5
biblio-style: apalike
---

Integration and simulation with fisheries
================================================================================

Early development of management strategy evaluation (MSE) models originated in fisheries [@Polacheck1999; @Smith1999; @Sainsbury2000]. Consequently, fisheries-focused software for MSE has been extensively developed, including R libraries that focus on the management of species of exceptional interest, such as the Atlantic Bluefin Tuna (*Thunnus thynnus*) [[ABFTMSE](https://github.com/ICCAT/abft-mse/tree/master/R_package/ABTMSE); @Carruthers2018; @Carruthers2018a], and Indian Ocean Bigeye (*T. obesus*) and Yellowfin (*T. albacares*) Tuna [[MSE-IO-BET-YFT](https://github.com/pjumppanen/MSE-IO-BET-YFT); @Kolody2016]. The largest of all such libraries is the Fisheries Library in R ([FLR](http://www.flr-project.org/)), which includes an extensive collection of tools targeted for fisheries science. The FLR library has been used in over a hundred [publications](http://www.flr-project.org/#publications) [recent publications include @Jardim2018; @Mackinson2018; @Utizi2018], and includes [an MSE framework](http://www.flr-project.org/doc/An_introduction_to_MSE_using_FLR.html) for evaluating different harvest control rules. 

As part of the [ConFooBio](https://sti-cs.org/confoobio/) project, a central focus of GMSE is on simulating the management of populations of conservation interest, with a particular emphasis on understanding conservation conflict; further development of GMSE is expected to continue with this as a priority, further building upon the decision-making algorithms of managers and users to better understand how conflict arises and can potentially be resolved. Hence, GMSE is not intended as a substitute for packages such as [FLR](http://www.flr-project.org/), but the integration of these packages with GMSE could make use of GSME's current and future simulation capabilities, and particularly the [genetic algorithm](). Such integration might be possible using the `gmse_apply` function, which allows for [custom defined submodels]() to be used within the GMSE framework, and with default GMSE submodels. Hence, GMSE might be especially useful for modelling the management of fisheries under conditions of increasing harvesting demands and stakeholder conflict. We do not attempt such an ambitious project here, but instead show how such a project could be developed through integration of [FLR](http://www.flr-project.org/) and `gmse_apply`. 

Here we follow a [Modelling Stock-Recruitment with FLSR](http://www.flr-project.org/doc/Modelling_stock_recruitment_with_FLSR.html) example, then integrate this example with `gmse_apply` to explore the behaviour of simulated fishers who are goal-driven to maximise their own harvest. We emphasise that this example is provided only as demonstration of how GMSE can potentially be integrated with already developed fisheries models, and is not intended to make recommendations for management in any population.

Integrating with the Fisheries Library in R ([FLR](http://www.flr-project.org/))
================================================================================

The FLR toolset includes [a series of pacakges](http://www.flr-project.org/#packages), with several [tutorials](http://www.flr-project.org/doc/index.html) for using them. For simplicity, we focus here on [a model of stock recruitment](http://www.flr-project.org/doc/Modelling_stock_recruitment_with_FLSR.html) to be used as the population model in `gmse_apply`. This population model will use sample data and one of the many available stock-recruitment models available in FLR, and a custom function will be written to return a single value for stock recruitment. Currently, `gmse_apply` requires that submodels return subfunction results either as scalar values or data frames that are structured in the same way as GMSE submodels. But interpretation of scalar values is left up to the user (e.g., population model results could be interpreted as abundance or biomass; manager policy could be interpreted as cost of harvesting or as total allowable catch). For simplicity, the observation (i.e., estimation) model will simply be the stock reported from the population model with error, and the manager model will be a total allowable catch calculated from the stock-recruitment relationship that accounts for the number of fishers in the system. The user model, however, will employ the full power of the default GMSE user function to simulate user actions. We first show how a custom function can be made that applies the FLR toolset to a population model.

Modelling stock-recruitment for the population model
================================================================================

Here we closely follow [a tutorial from the FLR project](http://www.flr-project.org/doc/Modelling_stock_recruitment_with_FLSR.html). To build the stock-recruitment model, the following packages are needed.

```{r, eval = FALSE}
install.packages(c("ggplot2"));
install.packages(c("FLCore"), repos="http://flr-project.org/R");
install.packages(c("ggplotFL"), repos="http://flr-project.org/R");
```

To start, we need to read in the `FLCore`, `FLFleet` and `ggplotFL` libraries.

```{r}
library(FLCore);
#library(FLFleet)
#library(ggplotFL);
```

For a simplified example in GMSE, we will simulate the process of stock recruitment over multiple time steps using an example stock-recruitment model. The stock-recruitment model describes the relationship between stock-recruitment and spawning stock biomass. The sample that we will work from is a recreation of the North Sea Herring (`nsher`) dataset available in the `FLCore` package. This data set includes recruitment and spawning stock biomass data between 1960 and 2004. First, we initialise an empty `FLSR` object and read in the recreated CSV data files. 

```{r}
newFL        <- FLSR(); # Initialises the empty FLSR object
rec.n        <- read.csv("data/SI5/nsher_rec.csv");
ssb.n        <- read.csv("data/SI5/nsher_ssb.csv");
print(rec.n);
```

The recruitment (`rec.n`) and spawning stock biomass (`ssb.n`) data need to be in the form of a vector, array, matrix to use them with `FLQuant`. We will convert `rec.n` and `ssb.n` into matrices.

```{r}
rec.m        <- as.matrix(rec.n);
ssb.m        <- as.matrix(ssb.n);
```

```{r}
Frec.m       <- FLQuant(rec.m, dimnames=list(age=1, year = 1960:2004));
Fssb.m       <- FLQuant(ssb.m, dimnames=list(age=1, year = 1960:2004));
Frec.m@units <- "10^3";
Fssb.m@units <- "t*10^3";

newFL@rec    <- Frec.m;
newFL@ssb    <- Fssb.m;
newFL@range  <- c(0, 1960, 0, 2004);

model(newFL) <- ricker();
```













<!---



The data below are derived from the [FLR tutorial](http://www.flr-project.org/doc/Loading_your_data_into_FLR.html), and the code below downloads the example data files into a temporary folder. 

```{r}
#temp_dir <- tempdir()
#download.file("http://flr-project.org/doc/src/loading_data.zip", file.path(dir, "loading_data.zip"))
#unzip(file.path(temp_dir, "loading_data.zip"), exdir = temp_dir);
```

We can read in the example file below and convert it into a matrix to be used in an [FLQuant](http://www.flr-project.org/FLCore/reference/FLQuant.html) object. Rows in this matrix indicate ages.

```{r}
#fish_data <- read.csv(file.path(temp_dir, "catch_numbers.csv"), row = 1);
#fish_data <- as.matrix(fish_data);
#print(fish_data[,1:8]);
```

For simplicity, we merge these ages down into a single vector.

```{r}
fish_data <- apply(X = fish_data, MARGIN = 2, FUN = sum);
```

We can now create a new [FLQuant](http://www.flr-project.org/FLCore/reference/FLQuant.html) object with the `fish_data` vector. This process is important; down below, it will be repeated in a function that gets used within the GMSE population model, as GMSE will need to incorporate newly simulated data in each time step.


```{r}
fish_data_flq <- FLQuant(fish_data, dimnames = list(year = 1957:2011));
```











The data below include sample results for recruitment and spawning-stock biomass (SSB) of North Sea herring. 

```{r}
data(nsher);
```

These data are structured using `FLStock`, an [S4](https://stat.ethz.ch/R-manual/R-devel/library/methods/html/Classes_Details.html) class of R objects. The code below creates an `FLSR` object, needed to create a stock-recruitment model.

```{r}
summary(nsher);
```

Notice that under `Model`, a Ricker model of stock-recruitment has already been fitted (many stock-recruitment models are available in FLCore; see the [FLSR tutorial](http://www.flr-project.org/doc/Modelling_stock_recruitment_with_FLSR.html) for more about fitting different models) and parameterised with Maximum Likelihood Estimation (MLE).  The code below shows how to apply the Beverton-Holt model model as an alternative, and the  `fmle` function parameterises the Beverton-Holt model model using the data in `nsher` and MLE.

```{r}
model(nsher) <- bevholt();
nsher        <- fmle(nsher);
summary(nsher);
```

We will use these tools to update the population model in GMSE.



a <- params(nsher)[[1]];
b <- params(nsher)[[2]];

rec(p4sr2);
ssb(p4sr2);



rec_year    <- as.numeric(attributes(rec(p4sr2))$dimnames$year);
ssb_year    <- as.numeric(attributes(ssb(p4sr2))$dimnames$year);
recruitment <- NULL;
for(year in 1:length(rec_year)){
    recruitment[year] <- rec(p4sr)[[year]];
}
spawning_stock_biomass <- NULL;
for(year in 1:length(ssb_year)){
    spawning_stock_biomass[year] <- ssb(p4sr)[[year]];
}


rec <- a * spawning_stock_biomass * exp(-b * spawning_stock_biomass);



rec(p4sr)[[51]] <- 4300



--->